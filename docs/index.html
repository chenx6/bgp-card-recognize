<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestdori data generator</title>
    <style>
        #result {
            display: flex;
            align-items: flex-start;
        }
    </style>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/datatables.net@1.10.24/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap5.min.css">
</head>

<body>
    <div class="container">
        <div class="row p-3">
            <ul class="nav navbar navbar-expand-lg navbar-light bg-light">
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" href="#">Wasmdori</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">Bestdori data generator</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Band girl party team builder</a>
                </li>
            </ul>
        </div>
        <div class="row p-1">
            <div class="input-group mb-3">
                <input type="file" id="input-buttom" class="form-control" onchange="handleFiles(this.files)">
                <button id="calculate" class="btn btn-primary">Calculate</button>
                <button id="generate" class="btn btn-primary">Generate</button>
            </div>
        </div>
        <div id="result" class="row p-1">
            <img id="show-img" hidden=true>
            <canvas id="show-canvas" class="col-md-8"></canvas>
            <canvas id="data-canvas" hidden=true></canvas>
            <div class="col-md-4">
                <table id="result-table" class="table table-striped">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Card name</th>
                            <th>Character</th>
                            <th>Selected</th>
                        </tr>
                    </thead>
                    <tbody id="result-tbody"></tbody>
                </table>
            </div>
        </div>
        <div class="row p-1">
            <div id="hint-text"></div>
            <textarea id="encoded-string" class="form-control" rows="3"></textarea>
        </div>
        <div class="row p-1">
            <div class="alert alert-primary" role="alert">
                <div>Help</div>
                <ul>
                    <li>First, click left-top button to open a screenshot</li>
                    <li>Second, click the left-top card in the picture</li>
                    <li>Third, select the correct card in table</li>
                    <li>Last, click "Generate" button to generate Bestdori's data</li>
                </ul>
            </div>
        </div>
    </div>
    <script lang="javascript">
        'use strict';
        let DISTRICT = 3, dict = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_', allGeneratedResult = new Set();
        let hashes, cards, characters, table;
        /**
         * Initlize global data
         */
        async function initData() {
            let response = await fetch("hashes.json");
            hashes = await response.text();
            response = await fetch("cards.json");
            cards = await response.json();
            response = await fetch("characters.json");
            characters = await response.json();
            console.log("Hash data loaded!");
        }

        /**
         * Draw canvas wrapper
         * @param {HTMLElement} img Image tag
         * @param {string} canvasId canvas tag's id
         * @param {boolean} setWidth set width by image's width or not
         */
        function drawCanvas(img, canvasId, setWidth) {
            let canvas = document.getElementById(canvasId);
            let ctx = canvas.getContext('2d');
            if (setWidth) {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            } else {
                let width = $("#show-canvas").width();
                let ratio = width / img.width;
                let height = img.height * ratio;
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, width, height);
            }
        }

        /**
         * Handle file input, read file and draw on canvas
         * @param {Array} files this.files
         */
        function handleFiles(files) {
            const file = files[0];
            let img = document.getElementById('show-img');
            img.classList.add("obj");
            img.file = file;

            let reader = new FileReader();
            reader.onload = (e) => {
                img.src = e.target.result
                img.onload = () => {
                    drawCanvas(img, "show-canvas", false);
                    drawCanvas(img, "data-canvas", true);
                }
            };
            reader.readAsDataURL(file);
        }

        /**
         * Turn number into encoded string
         * @param {number} t
         * @param {number} e length
         */
        function v(t, e) {
            let ret = '';
            for (let i = 0; i < e; i++) {
                let a = t % 64;
                t = Math.floor(t / 64);
                ret = dict[a] + ret;
            }
            return ret;
        }

        /**
         * Generate encoded string by card list
         * @param {Array} cards
         */
        function geneEncodedStr(cards) {
            let data = '';
            for (let i = 0; i < cards.length; i++) {
                let card = cards[i];
                data += card.id >= 10000 ? v(card.id - 10000 + 3072, 2) : v(card.id, 2);
                data += v(card.level, 1);
                data += v(1 * (card.exclude ? 1 : 0) + 2 * card.art + 4 * card.train + 8 * card.ep + 24 * card.skill, 2)
            }
            return data;
        }

        /**
         * Handle generate button, get selected card and turn them into encoded data
         */
        function handleGenerate() {
            $("#hint-text").text("Generating")
                .removeClass("alert alert-success")
                .addClass("alert alert-info");
            let data = table.$("#checkbox").serialize();
            if (data.length == 0) {
                return;
            }
            let selected = data.replaceAll("=on", "").split("&").map((v) => parseInt(v));
            let selectedCards = [];
            for (const i of selected) {
                let card = cards[i];
                let level = card.levelLimit + (card.stat.training ? 10 : 0);
                selectedCards.push({
                    id: i,
                    level: level,
                    exclude: false,
                    art: 1,
                    train: 1,
                    ep: 2,
                    skill: 0,
                });
            }
            let generated = geneEncodedStr(selectedCards);
            console.log('Generated: %s', generated);
            // Trim repeated data
            const perCardWidth = 5;
            for (let i = 0; i < generated.length; i += perCardWidth) {
                allGeneratedResult.add(generated.slice(i, i + perCardWidth));
            }
            let finalData = '';
            for (const v of allGeneratedResult) {
                finalData += v;
            }
            let generaetdTime = Date.now();
            let fullGenerated = `{"name":"generated-${generaetdTime}","server":3,"compression":"1","data":"${finalData}",
"items":{"Menu":[4,4,4,4],"Plaza":[4,4,4,4],"Roselia":[4,4,4,4,4,4,4],"Everyone":[4,4,4,4,4,4,4],"Magazine":[4,4,4],
"Afterglow":[4,4,4,4,4,4,4],"PoppinParty":[4,4,4,4,4,4,4],"PastelPalettes":[4,4,4,4,4,4,4],"HelloHappyWorld":[4,4,4,4,4,4,4]}}`;
            $("#encoded-string").val(fullGenerated);
            $("#hint-text").text("Generate success!").addClass("alert alert-success");
        }

        /**
         * Generate result table and checkbox
         * @param {Array} array card id array
         */
        function geneResultTable(array) {
            let resultTable = document.getElementById("result-tbody");
            if ($.fn.dataTable.isDataTable('#result-table')) {
                table.destroy();
            }
            resultTable.innerHTML = '';
            for (const i of array) {
                let card = cards[i];
                if (card === undefined) {
                    card = cards[1];
                }
                let character = characters[card.characterId];
                let index = array.indexOf(i);
                let template = `<tr>
                        <td>${index}</td>
                        <td>${card.prefix[DISTRICT]}</td>
                        <td>${character.characterName[DISTRICT]}</td>
                        <td><input type="checkbox" id="checkbox" name="${i}" class="form-check-input"></td>
                    </tr>`;
                resultTable.innerHTML += template;
            }
            table = $('#result-table').DataTable({
                "order": [[0, "asc"]],
                searching: false,
                "columnDefs": [
                    {
                        "targets": [0],
                        "visible": false,
                        "searchable": false
                    }
                ]
            });
        }

        /**
         * Handle select image event, process image and show result
         * @param {JQueryEventObject} event event
         */
        function handleSelectImage(event) {
            $("#hint-text").text("Calculating...")
                .removeClass("alert alert-success")
                .addClass("alert alert-info");
            // Calculate the click position in picture
            let image = document.getElementById('show-img');
            let canvas = document.getElementById("show-canvas");
            let canvasInfo = canvas.getBoundingClientRect();
            let x = Math.round(image.width * (event.clientX - canvasInfo.left) / canvasInfo.width);
            let y = Math.round(image.height * (event.clientY - canvasInfo.top) / canvasInfo.height);
            console.log("x: %d, y: %d", x, y);

            // Get canvas data
            let dataCanvas = document.getElementById("data-canvas");
            let ctx = dataCanvas.getContext('2d');
            let imageData = ctx.getImageData(0, 0, image.width, image.height);
            let uintArray = imageData.data;
            // Put data into heap
            const uint8tPtr = Module._malloc(uintArray.length);
            Module.HEAPU8.set(uintArray, uint8tPtr);

            let begin = Date.now();
            let v = Module.process(uint8tPtr, image.width, image.height, hashes, x, y);
            console.log("Using %dms to calculate!", Date.now() - begin);
            Module._free(uint8tPtr);
            // Put result into array for further process
            let result = [];
            for (let i = 0; i < v.size(); i++) {
                result.push(v.get(i));
            }
            console.log("Result size: %d", v.size());
            geneResultTable(result);
            $("#hint-text").text("Finished").addClass("alert alert-success");
        }

        $("#show-canvas").click(handleSelectImage);
        $("#generate").click(handleGenerate);
        var Module = {
            onRuntimeInitialized: () => { }
        };
        initData();
    </script>
    <script src="card_recognize.js"></script>
</body>

</html>